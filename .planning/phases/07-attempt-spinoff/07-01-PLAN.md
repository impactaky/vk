---
phase: 07-attempt-spinoff
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/types.ts
  - src/commands/attempt.ts
autonomous: true

must_haves:
  truths:
    - "User can run `vk attempt spin-off <id>` and a new task is created"
    - "User can run `vk attempt spin-off` from workspace branch and workspace is auto-detected"
    - "Created task has parent_workspace_id linking to source workspace"
    - "User is prompted for message if --message not provided"
    - "Title defaults to first line of message when --title not provided (per CONTEXT.md - NOT prompted)"
    - "Output shows task ID and title only (minimal output per CONTEXT.md)"
    - "Accepts --title and --message flags (--message maps to description field per CONTEXT.md)"
  artifacts:
    - path: "src/api/types.ts"
      provides: "CreateTask interface with parent_workspace_id field"
      contains: "parent_workspace_id"
    - path: "src/commands/attempt.ts"
      provides: "spin-off subcommand implementation"
      contains: "spin-off"
  key_links:
    - from: "src/commands/attempt.ts"
      to: "src/api/client.ts"
      via: "client.createTask()"
      pattern: "client\\.createTask"
    - from: "src/commands/attempt.ts"
      to: "src/utils/attempt-resolver.ts"
      via: "resolveWorkspaceFromBranch()"
      pattern: "resolveWorkspaceFromBranch"
---

<objective>
Implement `vk attempt spin-off` command to create a child task from the current workspace.

Purpose: Enable users to spawn related tasks that inherit context from the
current workspace via parent_workspace_id linking.

Output:

- Updated CreateTask interface with parent_workspace_id field
- New spin-off subcommand in attempt.ts
  </objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-attempt-spinoff/07-CONTEXT.md
@.planning/phases/07-attempt-spinoff/07-RESEARCH.md

# Source files to reference

@src/api/types.ts @src/commands/attempt.ts @src/commands/task.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parent_workspace_id to CreateTask interface</name>
  <files>src/api/types.ts</files>
  <action>
Add optional `parent_workspace_id` field to the CreateTask interface.

Currently CreateTask is (around lines 67-72):

```typescript
export interface CreateTask {
  project_id: string;
  title: string;
  description?: string;
  image_ids?: string[] | null;
}
```

Add `parent_workspace_id?: string | null;` after description field.

This enables the API to create tasks with parent workspace linking for the
spin-off workflow.
</action>
<verify> Run `deno check src/api/types.ts` to verify no TypeScript errors.
</verify>
<done> CreateTask interface includes optional parent_workspace_id field.
</done>
</task>

<task type="auto">
  <name>Task 2: Implement spin-off subcommand</name>
  <files>src/commands/attempt.ts</files>
  <action>
Add spin-off subcommand to attemptCommand following the established patterns.

**Command structure:**

```typescript
attemptCommand
  .command("spin-off")
  .description("Create a new task from current workspace")
  .arguments("[id:string]")
  .option("--project <id:string>", "Project ID (for fzf selection, auto-detected from git if omitted)")
  .option("--title <title:string>", "Task title")
  .option("--message <message:string>", "Initial message for the new task")
  .option("--from <file:file>", "Load message from file")
  .action(async (options, id) => { ... });
```

**Implementation flow:**

1. **Imports:** Add `Input` from `@cliffy/prompt` at the top import (line 2
   already has `Confirm`, add `Input`).

2. **Workspace resolution:** Use same pattern as `open` and `cd` commands
   (explicit ID > branch detection > error, NO fzf fallback):

```typescript
let workspaceId: string;
if (id) {
  workspaceId = id;
} else {
  const workspace = await resolveWorkspaceFromBranch(client);
  if (!workspace) {
    throw new Error("Not in a workspace branch. Provide workspace ID.");
  }
  workspaceId = workspace.id;
}
```

3. **Get workspace and task for project_id:**

```typescript
const workspace = await client.getWorkspace(workspaceId);
const parentTask = await client.getTask(workspace.task_id);
```

4. **Handle input (title and message):**
   - If `--from` provided: read file content as message, error if also --title
     or --message
   - Otherwise: prompt for message if not provided via --message
   - Default title: first line of message if --title not provided

```typescript
let title = options.title;
let message = options.message;

if (options.from) {
  if (options.title || options.message) {
    console.error("Error: Cannot use --from with --title or --message");
    Deno.exit(1);
  }
  message = await Deno.readTextFile(options.from);
  if (!title) {
    title = message.split("\n")[0].trim();
  }
} else {
  if (!message) {
    message = await Input.prompt("Message for new agent:");
  }
  if (!title) {
    title = message.split("\n")[0].trim();
  }
}
```

5. **Create task with parent_workspace_id:**

```typescript
const createTask: CreateTask = {
  project_id: parentTask.project_id,
  title,
  description: message,
  parent_workspace_id: workspaceId,
};

const task = await client.createTask(createTask);
```

6. **Simple output (per CONTEXT.md decision):**

```typescript
console.log(`${task.id} ${task.title}`);
```

**Import needed:** Add `CreateTask` to the imports from "../api/types.ts" (line
6-16).

**Error handling:** Use existing handleCliError pattern (try/catch wrapper).

**Position:** Add after the `cd` command (after line 1050), before the file
ends.
</action>
<verify> Run:

1. `deno check src/commands/attempt.ts` - TypeScript compiles without errors
2. `deno run --allow-all src/main.ts attempt spin-off --help` - Shows help with
   correct options
   </verify>
   <done>

- spin-off subcommand is registered and shows in `vk attempt --help`
- Command accepts [id:string] argument and --title, --message, --from, --project
  options
- Workspace auto-detection works from branch (same pattern as open/cd)
- Message prompt appears when --message not provided
- Title defaults to first line of message
- Task created with parent_workspace_id set to source workspace
- Output shows task ID and title
  </done>
  </task>

</tasks>

<verification>
1. `deno check src/api/types.ts src/commands/attempt.ts` - No TypeScript errors
2. `deno run --allow-all src/main.ts attempt --help` - Shows spin-off in subcommands list
3. `deno run --allow-all src/main.ts attempt spin-off --help` - Shows correct usage with all options
4. `deno task build` - Build succeeds
</verification>

<success_criteria>

- [ ] CreateTask interface has parent_workspace_id field
- [ ] spin-off subcommand exists in attempt command
- [ ] Command prompts for message when not provided
- [ ] Title defaults to first line of message when --title not provided
- [ ] --from flag reads message from file
- [ ] Workspace auto-detection from branch works (like open/cd commands)
- [ ] Task is created with parent_workspace_id linking to source workspace
- [ ] Output shows task ID and title (minimal output per CONTEXT.md)
- [ ] TypeScript compiles without errors
- [ ] Build succeeds </success_criteria>

<output>
After completion, create `.planning/phases/07-attempt-spinoff/07-01-SUMMARY.md`
</output>
