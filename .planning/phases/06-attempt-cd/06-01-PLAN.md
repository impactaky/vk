---
phase: 06-attempt-cd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/config.ts
  - src/commands/config.ts
  - src/utils/localhost.ts
  - src/commands/attempt.ts
autonomous: true

must_haves:
  truths:
    - "User can run `vk attempt cd <id>` and shell spawns in workspace directory"
    - "User can run `vk attempt cd` from workspace branch for auto-detection"
    - "For localhost API, local subshell spawns in agent_working_dir"
    - "For remote API, SSH session opens with cd to agent_working_dir"
    - "User can configure shell via `vk config set shell <shell>`"
  artifacts:
    - path: "src/utils/localhost.ts"
      provides: "isLocalhost function for API URL detection"
      exports: ["isLocalhost"]
    - path: "src/api/config.ts"
      provides: "shell preference in Config interface"
      contains: "shell?: string"
    - path: "src/commands/config.ts"
      provides: "shell config key in set command"
      contains: 'case "shell"'
    - path: "src/commands/attempt.ts"
      provides: "cd subcommand implementation"
      contains: '.command("cd")'
  key_links:
    - from: "src/commands/attempt.ts"
      to: "src/utils/localhost.ts"
      via: "isLocalhost import"
      pattern: "import.*isLocalhost.*from.*localhost"
    - from: "src/commands/attempt.ts"
      to: "src/api/config.ts"
      via: "loadConfig for shell preference"
      pattern: "loadConfig|config\\.shell"
    - from: "src/commands/attempt.ts"
      to: "Deno.Command"
      via: "spawn() for subshell/SSH"
      pattern: "new Deno\\.Command.*spawn"
---

<objective>
Add `vk attempt cd` command that navigates into a workspace's working directory.

Purpose: Users can quickly enter workspace directories without manually finding paths or SSH hosts. Supports both local (spawn subshell) and remote (SSH session) workflows.

Output: Working cd subcommand with shell configuration support.
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-attempt-cd/06-CONTEXT.md
@.planning/phases/06-attempt-cd/06-RESEARCH.md

# Reference implementation for subcommand pattern
@src/commands/attempt.ts
@src/api/config.ts
@src/commands/config.ts
@src/utils/attempt-resolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shell config and isLocalhost utility</name>
  <files>
    src/api/config.ts
    src/commands/config.ts
    src/utils/localhost.ts
  </files>
  <action>
1. **Extend Config interface** in `src/api/config.ts`:
   - Add `shell?: string` field to Config interface
   - No changes to loadConfig/saveConfig (they already handle arbitrary fields via JSON)

2. **Add shell key to config command** in `src/commands/config.ts`:
   - Add case "shell" in the switch statement that sets config.shell = value
   - Update description string to include "shell" in available keys: "Available keys: api-url, shell"
   - Display shell in show command: `console.log(\`Shell: \${config.shell || "(default: bash)"}\`);`

3. **Create isLocalhost utility** in `src/utils/localhost.ts`:
   - Export function `isLocalhost(apiUrl: string): boolean`
   - Parse URL using `new URL(apiUrl)`
   - Return true if hostname is: "localhost", "::1", starts with "127.", or equals "0.0.0.0"
   - Return false otherwise

Pattern from RESEARCH.md:
```typescript
export function isLocalhost(apiUrl: string): boolean {
  const url = new URL(apiUrl);
  const hostname = url.hostname.toLowerCase();
  if (hostname === 'localhost' || hostname === '::1') return true;
  if (hostname.startsWith('127.')) return true;
  if (hostname === '0.0.0.0') return true;
  return false;
}
```
  </action>
  <verify>
    - `deno check src/api/config.ts` passes
    - `deno check src/commands/config.ts` passes
    - `deno check src/utils/localhost.ts` passes
  </verify>
  <done>
    - Config interface has shell field
    - Config set/show commands handle shell key
    - isLocalhost function exists and correctly identifies localhost patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cd subcommand to attempt command</name>
  <files>src/commands/attempt.ts</files>
  <action>
Add `cd` subcommand to attemptCommand following the open command pattern.

**Import additions:**
```typescript
import { loadConfig } from "../api/config.ts";
import { isLocalhost } from "../utils/localhost.ts";
```

**Add cd subcommand** after the open command:

```typescript
// CD into workspace directory
attemptCommand
  .command("cd")
  .description("Navigate into a workspace's working directory")
  .arguments("[id:string]")
  .option(
    "--project <id:string>",
    "Project ID (for fzf selection, auto-detected from git if omitted)",
  )
  .action(async (options, id) => {
    try {
      const client = await ApiClient.create();

      // Resolve workspace ID (explicit > branch > error - NO fzf fallback, like open command)
      let workspaceId: string;
      if (id) {
        workspaceId = id;
      } else {
        const workspace = await resolveWorkspaceFromBranch(client);
        if (!workspace) {
          throw new Error("Not in a workspace branch. Provide workspace ID.");
        }
        workspaceId = workspace.id;
      }

      // Get workspace details for agent_working_dir and branch
      const workspace = await client.getWorkspace(workspaceId);

      if (!workspace.agent_working_dir) {
        throw new Error("Workspace has no working directory configured.");
      }

      // Load config for shell preference and API URL
      const config = await loadConfig();
      const shell = config.shell || Deno.env.get("SHELL") || "bash";

      // Check if API is local or remote
      if (isLocalhost(config.apiUrl)) {
        // Local: spawn subshell in workspace directory
        console.log(`Entering workspace: ${workspace.branch}`);

        const command = new Deno.Command(shell, {
          cwd: workspace.agent_working_dir,
          // stdio defaults to "inherit" for spawn() - interactive terminal
        });

        const process = command.spawn();
        const status = await process.status;

        console.log("Exited workspace shell");

        if (!status.success) {
          throw new Error(`Shell exited with code ${status.code}`);
        }
      } else {
        // Remote: SSH into host with cd to workspace directory
        // Extract host from API URL
        const apiUrl = new URL(config.apiUrl);
        const host = apiUrl.hostname;

        console.log(`Entering workspace: ${workspace.branch}`);

        // Use exec to replace ssh process with shell for clean exit
        const command = new Deno.Command("ssh", {
          args: [
            "-t",
            host,
            `cd "${workspace.agent_working_dir}" && exec ${shell}`
          ],
          // stdio inherited by default for spawn()
        });

        const process = command.spawn();
        const status = await process.status;

        console.log("Exited workspace shell");

        if (!status.success) {
          throw new Error(`SSH session exited with code ${status.code}`);
        }
      }
    } catch (error) {
      handleCliError(error);
      throw error;
    }
  });
```

**Key implementation details from CONTEXT.md:**
- Message format: "Entering workspace: <branch>" before spawn
- Message "Exited workspace shell" after exit
- All failures are errors (no fallbacks)
- Quote path in SSH command for spaces
- Use `exec ${shell}` in SSH for clean exit
- Use `-t` flag for pseudo-terminal allocation
  </action>
  <verify>
    - `deno check src/commands/attempt.ts` passes
    - `deno task build` completes without errors (if build task exists)
    - `deno run --allow-all src/main.ts attempt cd --help` shows cd command help
  </verify>
  <done>
    - `vk attempt cd <id>` spawns shell in workspace directory
    - `vk attempt cd` auto-detects workspace from branch
    - Local API: spawns local subshell with configured shell
    - Remote API: opens SSH session to API host with cd to agent_working_dir
  </done>
</task>

</tasks>

<verification>
1. `deno check src/**/*.ts` - All TypeScript compiles
2. `deno task test` - All existing tests pass (if test task exists)
3. Manual verification:
   - `vk config set shell zsh` - Sets shell preference
   - `vk config show` - Shows shell setting
   - `vk attempt cd <workspace-id>` - Spawns shell in workspace directory
   - From workspace branch: `vk attempt cd` - Auto-detects and spawns shell
</verification>

<success_criteria>
1. CD-01: `vk attempt cd [id]` spawns shell in workspace workdir
2. CD-02: For localhost API, local subshell spawns (not SSH)
3. CD-03: For remote API, SSH session opens with cd to agent_working_dir
4. CD-04: Shell configurable via `vk config set shell <shell>`
5. CD-05: Works with auto-detection from current branch
</success_criteria>

<output>
After completion, create `.planning/phases/06-attempt-cd/06-01-SUMMARY.md`
</output>
