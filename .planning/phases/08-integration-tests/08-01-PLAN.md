---
phase: 08-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - tests/cli_commands_integration_test.ts
autonomous: true

must_haves:
  truths:
    - "Integration test validates spin-off creates task with correct parent_workspace_id"
    - "Integration test validates config set/get shell persists and retrieves value"
    - "Tests run successfully via docker compose run --rm vk"
  artifacts:
    - path: "tests/cli_commands_integration_test.ts"
      provides: "CLI command integration tests"
      contains: "vk attempt spin-off"
    - path: "docker-compose.yml"
      provides: "Updated test permissions"
      contains: "--allow-run"
  key_links:
    - from: "tests/cli_commands_integration_test.ts"
      to: "src/main.ts"
      via: "Deno.Command subprocess"
      pattern: "Deno\\.Command.*src/main\\.ts"
    - from: "tests/cli_commands_integration_test.ts"
      to: "/api/tasks"
      via: "apiCall verification"
      pattern: "apiCall.*tasks"
---

<objective>
Add integration tests for CLI commands: `vk attempt spin-off` and `vk config set/get shell`.

Purpose: Validate the v1.1 features work correctly end-to-end with the API, completing TEST-01 and TEST-02 requirements.
Output: New test file `tests/cli_commands_integration_test.ts` that runs via `docker compose run --rm vk`.
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-tests/08-CONTEXT.md
@.planning/phases/08-integration-tests/08-RESEARCH.md

# Source files being tested
@src/commands/attempt.ts
@src/commands/config.ts

# Existing test patterns to follow
@tests/api_integration_test.ts
@tests/helpers/test-server.ts
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update docker-compose.yml for CLI subprocess tests</name>
  <files>docker-compose.yml</files>
  <action>
Add `--allow-run` permission to the vk service test command.

Current command:
```yaml
command: deno test --allow-net --allow-read --allow-write --allow-env
```

Updated command:
```yaml
command: deno test --allow-net --allow-read --allow-write --allow-env --allow-run
```

This enables `Deno.Command` subprocess execution required for CLI integration tests.
  </action>
  <verify>
Run `grep -q "allow-run" docker-compose.yml` returns success (exit 0).
  </verify>
  <done>
docker-compose.yml contains `--allow-run` in the vk service command.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI commands integration test file</name>
  <files>tests/cli_commands_integration_test.ts</files>
  <action>
Create `tests/cli_commands_integration_test.ts` with tests for:

**1. Spin-off happy path (TEST-01):**
- Create project with repo
- Create task in project
- Create workspace (attempt) for task
- Run CLI: `deno run --allow-net --allow-read --allow-write --allow-env src/main.ts attempt spin-off {workspaceId} --title "Child task" --message "Test message"`
- Parse task ID from output (format: `{id} {title}`)
- Verify via API: GET `/tasks/{taskId}` returns task with `parent_workspace_id === workspaceId`
- Cleanup: delete project (cascades to task, workspace)

**2. Config set/get shell (TEST-02):**
- Use isolated HOME directory: `/tmp/test-home-{timestamp}`
- Run CLI: `vk config set shell zsh` with HOME env var
- Verify file: Read `$HOME/.config/vibe-kanban/vk-config.json`, check `shell === "zsh"`
- Run CLI: `vk config show` with same HOME
- Verify output contains "zsh"
- Cleanup: remove test HOME directory

**Implementation patterns (from RESEARCH.md):**

```typescript
// Subprocess execution pattern
const command = new Deno.Command("deno", {
  args: ["run", "--allow-net", "--allow-read", "--allow-write", "--allow-env",
         "src/main.ts", "attempt", "spin-off", workspaceId,
         "--title", "Child task", "--message", "Test message"],
  stdout: "piped",
  stderr: "piped",
  env: {
    VK_API_URL: "http://vibe-kanban:3000",
    HOME: testHome,
  },
});

const { code, stdout, stderr } = await command.output();
const stdoutText = new TextDecoder().decode(stdout);
assertEquals(code, 0, `Command failed: ${new TextDecoder().decode(stderr)}`);
```

**Follow existing patterns from api_integration_test.ts:**
- Import `assertEquals`, `assertExists`, `assert` from `@std/assert`
- Import `config` from `./helpers/test-server.ts`
- Use `apiCall<T>()` helper pattern for API verification
- Use `createTestRepoDir()` for git repo setup
- Use try/finally for cleanup
- Test naming: `Deno.test("CLI: ...")`
  </action>
  <verify>
1. Run `deno check tests/cli_commands_integration_test.ts` - no type errors
2. Run `docker compose run --rm vk` - all tests pass including new CLI tests
  </verify>
  <done>
- tests/cli_commands_integration_test.ts exists with spin-off and config tests
- All tests pass in docker compose test run
- TEST-01 and TEST-02 requirements satisfied
  </done>
</task>

</tasks>

<verification>
```bash
# Run full integration test suite including new CLI tests
docker compose run --rm vk

# Expected: All tests pass, including:
# - "CLI: vk attempt spin-off creates task with parent_workspace_id"
# - "CLI: vk config set/get shell persists value"
```
</verification>

<success_criteria>
1. docker-compose.yml includes `--allow-run` permission
2. tests/cli_commands_integration_test.ts exists with proper structure
3. Spin-off test creates task and verifies parent_workspace_id via API
4. Config test sets shell value and verifies persistence
5. All integration tests pass via `docker compose run --rm vk`
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-tests/08-01-SUMMARY.md`
</output>
