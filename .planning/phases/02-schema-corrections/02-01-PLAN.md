---
phase: 02-schema-corrections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/types.ts
  - src/api/client.ts
  - src/commands/attempt.ts
autonomous: true

must_haves:
  truths:
    - "User can run `vk attempt branch-status` and see status for each repo in a table"
    - "User can run `vk attempt branch-status --repo <id>` to see detailed status for one repo"
    - "User can run `vk attempt pr-comments` and it resolves repo automatically for single-repo workspaces"
    - "User gets clear error for multi-repo workspaces when --repo not specified on pr-comments"
  artifacts:
    - path: "src/api/types.ts"
      provides: "RepoBranchStatus, Merge, ConflictOp types"
      contains: "interface RepoBranchStatus"
    - path: "src/api/client.ts"
      provides: "Updated getBranchStatus and getPRComments methods"
      contains: "RepoBranchStatus[]"
    - path: "src/commands/attempt.ts"
      provides: "Updated branch-status and pr-comments commands with --repo flag"
      contains: "--repo <id:string>"
  key_links:
    - from: "src/commands/attempt.ts"
      to: "src/api/types.ts"
      via: "RepoBranchStatus import"
      pattern: "import.*RepoBranchStatus"
    - from: "src/commands/attempt.ts"
      to: "src/api/client.ts"
      via: "getBranchStatus returns array"
      pattern: "client\\.getBranchStatus"
    - from: "src/commands/attempt.ts"
      to: "src/api/client.ts"
      via: "getPRComments with repoId parameter"
      pattern: "client\\.getPRComments\\(workspaceId, repoId\\)"
---

<objective>
Fix multi-repo workspace schema mismatches in branch-status and pr-comments commands

Purpose: Enable users to properly view branch status and PR comments for multi-repo workspaces. Currently `branch-status` expects a single object but API returns an array, and `pr-comments` requires a `repo_id` parameter for multi-repo workspaces.

Output:
- RepoBranchStatus type with all API fields
- Updated API client with correct return types and parameters
- Updated commands with --repo flag and multi-repo display
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-schema-corrections/02-RESEARCH.md

# Source files to modify
@src/api/types.ts
@src/api/client.ts
@src/commands/attempt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RepoBranchStatus and related types to types.ts</name>
  <files>src/api/types.ts</files>
  <action>
Add the following types to src/api/types.ts:

1. Add `RepoBranchStatus` interface with all fields from API schema:
   - repo_id: string
   - repo_name: string
   - commits_behind: number
   - commits_ahead: number
   - has_uncommitted_changes: boolean
   - head_oid: string
   - uncommitted_count: number
   - untracked_count: number
   - target_branch_name: string
   - remote_commits_behind: number
   - remote_commits_ahead: number
   - merges: Merge[]
   - is_rebase_in_progress: boolean
   - conflict_op: ConflictOp | null
   - conflicted_files: string[]
   - is_target_remote: boolean

2. Add `ConflictOp` type: "rebase" | "merge" | "cherry_pick" | "revert"

3. Add `Merge` interface with fields:
   - oid: string
   - message: string

4. Keep the existing `BranchStatus` interface but add a comment marking it as deprecated, pointing to `RepoBranchStatus`.

Place these after the existing `BranchStatus` interface (around line 165-170).
  </action>
  <verify>Run `deno check src/api/types.ts` to verify no TypeScript errors</verify>
  <done>RepoBranchStatus, ConflictOp, and Merge types are exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Update API client methods for multi-repo support</name>
  <files>src/api/client.ts</files>
  <action>
Update the API client methods in src/api/client.ts:

1. Add import for RepoBranchStatus type at the top imports section

2. Change `getBranchStatus` method return type from `Promise<BranchStatus>` to `Promise<RepoBranchStatus[]>`:
   ```typescript
   getBranchStatus(id: string): Promise<RepoBranchStatus[]> {
     return this.request<RepoBranchStatus[]>(`/task-attempts/${id}/branch-status`);
   }
   ```

3. Add `repoId` parameter to `getPRComments` method and include as query parameter:
   ```typescript
   getPRComments(id: string, repoId: string): Promise<UnifiedPRComment[]> {
     return this.request<UnifiedPRComment[]>(
       `/task-attempts/${id}/pr/comments?repo_id=${repoId}`
     );
   }
   ```

Note: Keep BranchStatus in the imports for backward compatibility if it's still used elsewhere, but add RepoBranchStatus import.
  </action>
  <verify>Run `deno check src/api/client.ts` to verify no TypeScript errors</verify>
  <done>getBranchStatus returns RepoBranchStatus[] array, getPRComments accepts repoId parameter</done>
</task>

<task type="auto">
  <name>Task 3: Update branch-status and pr-comments commands with --repo flag</name>
  <files>src/commands/attempt.ts</files>
  <action>
Update the commands in src/commands/attempt.ts:

1. Add `RepoBranchStatus` to the imports from "../api/types.ts"

2. Update the `branch-status` command (around line 540-572):
   - Add `--repo` option: `.option("--repo <id:string>", "Repository ID (auto-detected if workspace has only one repo)")`
   - Change the action handler to:
     a. Get array of statuses from `client.getBranchStatus(workspaceId)`
     b. If --json flag, output full array
     c. If --repo flag provided, filter to single repo and display detailed view:
        - Display: Repo, Target Branch, Ahead (commits), Behind (commits), Remote Ahead, Remote Behind, Uncommitted (files), Untracked (files), Has Changes (Yes/No), Rebase In Progress (Yes/No), and if conflict_op exists show Conflict Operation and Conflicted Files count
     d. If no --repo flag:
        - Display table with columns: Repo, Target Branch, Ahead, Behind, Changes, Conflicts
        - Use `s.repo_name || s.repo_id` for Repo column
        - Show tip if multiple repos: "Tip: Use --repo <id> to see detailed status for a specific repository"

3. Update the `pr-comments` command (around line 720-767):
   - Add `--repo` option: `.option("--repo <id:string>", "Repository ID (auto-detected if workspace has only one repo)")`
   - Before calling `client.getPRComments`, resolve repo_id using existing `getRepoIdForWorkspace()` helper:
     ```typescript
     const repoId = await getRepoIdForWorkspace(client, workspaceId, options.repo);
     ```
   - Update the API call to pass repoId: `client.getPRComments(workspaceId, repoId)`
  </action>
  <verify>
Run `deno check src/commands/attempt.ts` to verify no TypeScript errors.
Run `deno task test` to ensure no test regressions.
  </verify>
  <done>
branch-status command displays table for multi-repo, detailed view for single repo or with --repo flag.
pr-comments command uses getRepoIdForWorkspace() to resolve repo and passes to API.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check passes:**
   ```bash
   deno check src/api/types.ts src/api/client.ts src/commands/attempt.ts
   ```

2. **Tests pass:**
   ```bash
   deno task test
   ```

3. **Help text shows --repo flag:**
   ```bash
   deno task dev attempt branch-status --help
   deno task dev attempt pr-comments --help
   ```
   Both should show `--repo <id:string>` option.

4. **Manual verification (if API available):**
   - `vk attempt branch-status` shows table with repo info
   - `vk attempt branch-status --repo <id>` shows detailed single-repo view
   - `vk attempt pr-comments` works for single-repo workspace
   - `vk attempt pr-comments` on multi-repo workspace without --repo gives clear error
</verification>

<success_criteria>
- RepoBranchStatus, Merge, ConflictOp types exist in types.ts
- getBranchStatus returns RepoBranchStatus[] array
- getPRComments accepts repoId parameter
- branch-status command has --repo flag and displays table/detailed view appropriately
- pr-comments command has --repo flag and resolves repo using existing helper
- All type checks pass
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-schema-corrections/02-01-SUMMARY.md`
</output>
