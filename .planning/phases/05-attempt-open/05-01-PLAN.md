---
phase: 05-attempt-open
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/attempt.ts
autonomous: true

must_haves:
  truths:
    - "User can run `vk attempt open <id>` and browser opens to workspace URL"
    - "User can run `vk attempt open` from a workspace branch and browser opens automatically"
    - "URL correctly points to `<API_URL>/workspaces/<workspace_id>`"
    - "Command is silent on success (no output when browser opens)"
    - "URL is printed only when browser fails to launch"
  artifacts:
    - path: "src/commands/attempt.ts"
      provides: "attempt open subcommand"
      contains: ".command(\"open\")"
  key_links:
    - from: "src/commands/attempt.ts"
      to: "@opensrc/deno-open"
      via: "import { open }"
      pattern: "import.*open.*from.*deno-open"
    - from: "src/commands/attempt.ts"
      to: "src/utils/attempt-resolver.ts"
      via: "resolveWorkspaceFromBranch()"
      pattern: "resolveWorkspaceFromBranch"
    - from: "src/commands/attempt.ts"
      to: "src/api/config.ts"
      via: "getApiUrl()"
      pattern: "getApiUrl"
---

<objective>
Add `vk attempt open [id]` command that opens a workspace in the browser.

Purpose: Provide quick browser access to workspace UI from the command line, completing the "attempt open" feature for v1.1.

Output: Working `vk attempt open` command that follows Unix philosophy (silent on success) and uses existing workspace resolution infrastructure.
</objective>

<execution_context>
@/home/impactaky/shelffiles/config/claude/get-shit-done/workflows/execute-plan.md
@/home/impactaky/shelffiles/config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-attempt-open/05-CONTEXT.md
@.planning/phases/05-attempt-open/05-RESEARCH.md
@src/commands/attempt.ts
@src/commands/task.ts (reference: task open command at lines 319-349)
@src/utils/attempt-resolver.ts (reference: resolveWorkspaceFromBranch)
@src/api/config.ts (reference: getApiUrl)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add attempt open subcommand</name>
  <files>src/commands/attempt.ts</files>
  <action>
Add the `open` subcommand to attemptCommand in src/commands/attempt.ts.

1. Add import for `open` from `@opensrc/deno-open` (add to existing imports)
2. Add import for `getApiUrl` from `../api/config.ts`
3. Update import from `../utils/attempt-resolver.ts` to include `resolveWorkspaceFromBranch`:
   Change: `import { getAttemptIdWithAutoDetect, getTaskIdWithAutoDetect }`
   To: `import { getAttemptIdWithAutoDetect, getTaskIdWithAutoDetect, resolveWorkspaceFromBranch }`
4. Add the `open` subcommand after the existing `pr-comments` command (near end of file)

Implementation details per CONTEXT.md decisions:

```typescript
// Add to imports at top of file
import { open } from "@opensrc/deno-open";
import { getApiUrl } from "../api/config.ts";
// Update existing import to include resolveWorkspaceFromBranch
import { getAttemptIdWithAutoDetect, getTaskIdWithAutoDetect, resolveWorkspaceFromBranch } from "../utils/attempt-resolver.ts";

// Add subcommand (append after pr-comments command)
attemptCommand
  .command("open")
  .description("Open a workspace in the browser")
  .arguments("[id:string]")
  .option(
    "--project <id:string>",
    "Project ID (for fzf selection, auto-detected from git if omitted)",
  )
  .action(async (options, id) => {
    try {
      const client = await ApiClient.create();

      // Resolve workspace ID (explicit > branch > error - NO fzf fallback)
      let workspaceId: string;
      if (id) {
        workspaceId = id;
      } else {
        const workspace = await resolveWorkspaceFromBranch(client);
        if (!workspace) {
          throw new Error("Not in a workspace branch. Provide workspace ID.");
        }
        workspaceId = workspace.id;
      }

      // Construct URL
      const baseUrl = await getApiUrl();
      const url = `${baseUrl}/workspaces/${workspaceId}`;

      // Open in browser (fire-and-forget, silent on success)
      try {
        await open(url);
      } catch {
        // Print URL as fallback if browser launch fails
        console.log(`Could not open browser. Visit: ${url}`);
      }
    } catch (error) {
      handleCliError(error);
      throw error;
    }
  });
```

Key differences from task open per CONTEXT.md:
- NO console.log before opening (silent on success)
- NO fzf fallback - error if no ID and not on workspace branch
- NO API call to validate workspace exists (trust the ID)
- URL format is `/workspaces/{id}` not `/projects/{pid}/tasks/{tid}`
- Print URL only on browser launch failure
  </action>
  <verify>
1. `deno check src/commands/attempt.ts` passes (no type errors)
2. `deno task cli attempt open --help` shows the open command with correct description
  </verify>
  <done>
- attempt open subcommand exists with [id] argument and --project option
- Command uses resolveWorkspaceFromBranch() for branch auto-detection
- Command errors (not fzf) when no ID and not on workspace branch
- No output on successful browser launch
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify command behavior</name>
  <files>src/commands/attempt.ts</files>
  <action>
Test the command behavior by running a series of verification checks:

1. Help output verification:
   ```bash
   deno task cli attempt open --help
   ```
   Expected: Shows description "Open a workspace in the browser", [id] argument, --project option

2. Error handling verification (no ID, not on workspace branch):
   ```bash
   cd /tmp && deno task --cwd {project_dir} cli attempt open 2>&1
   ```
   Expected: Error message "Not in a workspace branch. Provide workspace ID."

3. With explicit ID (will attempt to open browser - just verify no crash):
   Run from the project directory with a fake ID to verify URL construction:
   ```bash
   VK_API_URL=http://test.example.com deno task cli attempt open test-workspace-id 2>&1 || true
   ```
   This will either:
   - Open browser to http://test.example.com/workspaces/test-workspace-id (success case)
   - Print "Could not open browser. Visit: http://test.example.com/workspaces/test-workspace-id" (fallback case)
   Either confirms URL construction is correct.

Note: Full integration testing with real workspace IDs is done in Phase 8.
  </action>
  <verify>
1. `deno task cli attempt --help` lists "open" in available commands
2. `deno task cli attempt open --help` shows expected options
3. Running without ID outside workspace branch shows error (not fzf prompt)
  </verify>
  <done>
- Help shows open command with correct description
- Error message displayed when no ID and not on workspace branch
- URL format is `{API_URL}/workspaces/{id}` (verified via error fallback output or manual test)
  </done>
</task>

</tasks>

<verification>
1. `deno check src/commands/attempt.ts` - Type checking passes
2. `deno task cli attempt open --help` - Shows correct usage
3. Manual test: Run `vk attempt open` outside workspace branch - shows error not fzf
4. Manual test: Run `vk attempt open <real-id>` - browser opens (or URL printed if no browser)
</verification>

<success_criteria>
Requirements covered:
- [x] OPEN-01: `vk attempt open [id]` opens workspace in browser
- [x] OPEN-02: URL format is `<API_URL>/workspaces/<workspace_id>`
- [x] OPEN-03: Supports auto-detect from current branch

Behavior:
- Command is silent on success (Unix philosophy per CONTEXT.md)
- No fzf fallback - errors clearly when workspace cannot be determined
- URL printed only when browser launch fails (fallback per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/05-attempt-open/05-01-SUMMARY.md`
</output>
